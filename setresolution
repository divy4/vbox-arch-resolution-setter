#!/usr/bin/env bash

set -e

function main() {
  local width height refresh mode_name
  validate_args "$@"
  width="$1"
  height="$2"
  refresh="$3"

  if mode_exists; then
    set_mode '1920x1440'
    delete_mode
    remove_mode
  fi
  create_mode "$width" "$height" "$refresh"
  add_mode
  set_mode custom
}

function mode_exists() {
  xrandr --query | grep "custom" > /dev/null
}

function create_mode() {
  local width height refresh mode_name mode
  width="$1"
  height="$2"
  refresh="$3"
  mode_name="$4"
  mode="$(gtf "$width" "$height" "$refresh" | awk 'NR==3 {print}' | awk '{for (i=3; i<=NF; i++) printf $i " "}')"
  xrandr --newmode custom $mode
}

function remove_mode() {
  xrandr --rmmode custom
}

function add_mode() {
  xrandr --addmode Virtual-1 custom
}

function delete_mode() {
  xrandr --delmode Virtual-1 custom
}

function set_mode() {
  xrandr --output Virtual-1 --mode "$1"
}

function validate_args() {
  if [[ "$#" -ne 3 ]]; then
    echo_err "Usage: $0 WIDTH HEIGHT REFRESH_RATE"
    return 1
  fi
  validate_number "$1"
  validate_number "$2"
  validate_number "$3"
}

function validate_number() {
  if [[ ! "$1" =~ ^[0-9]+$ ]]; then
    echo_err "Invalid number: $1"
    return 1
  fi
}

function echo_err() {
  >&2 echo "$@"
}

main "$@"
